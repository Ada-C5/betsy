<h1>This your order fulfillment page ðŸ’°</h1>

<div class="panel panel-primary">
  Your total Revenue including pending and cancel orders is <span class="input-group-addon" id="sizing-addon1"><%= @total_revenue %></span>
</div>

<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">Panel heading</div>
  <table class="table">
    <tr>
      <th>Status</th>
      <th>Revenue by Status</th>
      <th>Number of orders</th>
    </tr>
    <% @grouped_by_status.each do |status, array| %>
    <tr>
      <td><%= status.capitalize %></td>
      <td><%= array.map { |item| item.product.price }.sum %></td>
      <td><span class="badge"><%= array.map { |item| item.order_id }.count %></span></td>
      <%end%>
    </tr>
  </table>
</div>


<div class="btn-group">
<% states_for_select = @grouped_by_status.keys.map { |s| [s.capitalize, s] } %>
<%= form_tag user_orders_path, method: :get do %>
<%= select_tag(:order_state, options_for_select(states_for_select,
:selected => params[:order_state]), :prompt => "Filter orders by status", class: "btn btn-default dropdown-toggle") %>

<%= submit_tag "Submit", class: "btn btn-primary" %>
<% end %>
</div>
<br>
<br>
<div class="panel panel-primary">
  <div class="panel-heading"><h3><%=params[:order_state]%></h3></div>
  <div class="row">
    <% @orders.each do |order| %>
    <div class="col-sm-6 col-md-4">
      <div class="thumbnail">
        <div class="caption">
          <h3>
            <%=link_to "Order id: #{order.id}", user_order_path(@user.id, order.id) %>
          </h3>

          <br>
          <p> Buyer: <%= order.user.name%></p>
          <p> Products:
            <div class="list-group">
            <% OrderItem.where(order_id: order.id).map do |order_item|  %>
          <tr>
            <td><%= link_to order_item.product.name, order_item_path(order_item.id), class: "list-group-item"%><td>
          </tr>
          <% end %>
        </div>
        </p>

          <p><a href="#" class="btn btn-primary" role="button">See</a>
          </div>
        </div>
      </div>
      <% end %>
    </div>
  </div>

  <div class="panel panel-primary">
    <div class="panel-heading"><h3>A list of orders including at least one of my products:
    </h3></div>

    <div class="row">
      <% @grouped_by_order.each do |order_id, array| %>
      <div class="col-sm-6">
        <div class="thumbnail">
          <div class="caption">
            <h3> Order id :<%= Order.find(order_id).id %></h3>
            <!-- Each order item sold by me with a quantity and line-item subtotal -->

            <strong>Items: </strong>
            <table class="table table-hover">
              <tr>
                <th><strong> Product: </strong></th>
                <th><strong> Quantity: </strong></th>
                <th><strong> Subtotal: </strong></th>
              </tr>
                <% OrderItem.where(order_id: order_id).map do |order_item|  %>
              <tr data-link="<%= order_item_path(order_item.id) %>">
                <td><%= link_to order_item.product.name, order_item_path(order_item.id)%><td>
                <td><%= order_item.quantity %></td>
                <td><%= order_item.product.price * order_item.quantity %></td>
              </tr>
              <% end %>
            </table>
              <strong>State:</strong> <%= Order.find(order_id).order_state%>
              <br>
              <strong>Placed at:</strong> <%= Order.find(order_id).created_at%>

            </div>
          </div>
        </div>
        <%end%>
      </div>

    </div>
